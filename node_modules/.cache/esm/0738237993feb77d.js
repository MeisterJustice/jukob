let mysql,dbconfig,util,User;_93f‍.x([["getIndex",()=>getIndex],["getsignup",()=>getsignup],["postsignup",()=>postsignup],["getLogin",()=>getLogin],["postLogin",()=>postLogin],["getLogout",()=>getLogout],["getProfile",()=>getProfile],["getProfileSettings",()=>getProfileSettings],["putProfile",()=>putProfile]]);_93f‍.w("mysql",[["default",["mysql"],function(v){mysql=v}]]);_93f‍.w("../config/database",[["default",["dbconfig"],function(v){dbconfig=v}]]);_93f‍.w("util",[["default",["util"],function(v){util=v}]]);_93f‍.w("../models",[["default",["User"],function(v){User=v}]]);



const cloudinary = require('../config/cloudinary');
var connection = mysql.createConnection(dbconfig.connection);


       const getIndex = async (req, res, next) => {
  res.render('index', { title: 'Express' });
}


       const getsignup = async (req, res, next) => {
  res.render('auth/signup', { message: req.flash('signupMessage') });
}

       const postsignup = async (req, res, next) => {
  try {
    if (req.file) {
      const { secure_url, public_id } = req.file;
      req.body.image = {
        secure_url,
        public_id
      }
    }
    let newUser = await new User({
      email: req.body.email,
      username: req.body.username
    });
    const user = await User.register(newUser, req.body.password);
    const data = await { username: user.username, email: user.email, password: user.salt, secure_image_url: user.image.secure_url };
    const insertUser = `INSERT INTO users SET ?`;
    connection.query(insertUser, data, (err, result) => {
      if (err) {
        _93f‍.g.console.log(err);
        req.flash('error', `could not authenticate you`);
        res.redirect('/signup');
      };
      req.login(user, function (err) {
        if (err) {
          req.flash('error', `${err}`);
          return res.redirect('/login');
        }
        req.flash('success', `We're pleased to have you, ${user.username}!`);
        res.redirect('/');
      });
    })
  } catch (err) {
    deleteProfileImage(req);
    const { username, email } = req.body;
    let error = err.message;
    if (error.includes('duplicate') && error.includes('index: email_1 dup key')) {
      error = 'A user with the given email is already registered';
    }
    res.render('auth/signup', { title: 'Register', username, email, error });
  }
}

       const getLogin = async (req, res, next) => {
  res.render('auth/login', { message: req.flash('loginMessage') });
}

       const postLogin = async (req, res, next) => {
  const {
    username,
    password
  } = req.body;
  const {
    user,
    error
  } = await User.authenticate()(username, password);
  if (!user && error) {
    req.flash('error', "Wrong username or password!");
    return res.redirect('/login');
  }
  req.login(user, function (err) {
    if (err) return res.redirect('/login');
    req.flash('success', `Welcome back ${username}`);
    const redirectUrl = req.session.redirectTo || '/';
    delete req.session.redirectTo;
    res.redirect(redirectUrl);
  });
}

       const getLogout = async (req, res, next) => {
  req.logout();
  res.redirect('/');
}

       const getProfile = async (req, res, next) => {
  connection.query(`SELECT * FROM users WHERE username = '${req.user.username}'`, (err, result) => {
    if (err) throw err;
    res.render('profile/profile', { user: result[0] });
  })
}

       const getProfileSettings = async (req, res, next) => {
  let findUserInfo = `SELECT * FROM users WHERE username = '${req.user.username}'`;
  connection.query(findUserInfo, (err, result) => {
    if (err) throw err;
    res.render('profile/settings', { user: result[0] });
  })

}

       const putProfile = async (req, res, next) => {
  const {
    username,
    email,
    first_name,
    last_name,
    phone_number,
  } = req.body;
  const user = await User.findById(req.user._id);
  if (username) user.username = username;
  if (email) user.email = email;
  if (req.file) {
    if (user.image.public_id) await cloudinary.v2.uploader.destroy(user.image.public_id);
    const { secure_url, public_id } = req.file;
    user.image = { secure_url, public_id };
    let data = { username: username, email: email, first_name: first_name, last_name: last_name, phone_number: phone_number, secure_image_url: secure_url, public_image_id: public_id };
    let updateUser = `UPDATE users SET ? WHERE username = '${req.user.username}'`;
    connection.query(updateUser, data, (err, result2) => {
      if (err) throw err;
    });
  }
  let data = { username: username, email: email, first_name: first_name, last_name: last_name, phone_number: phone_number };
  let updateUser = `UPDATE users SET ? WHERE username = '${req.user.username}'`;
  await user.save();
  await connection.query(updateUser, data, (err, result2) => {
    if (err) throw err;
  });
  const login = await util.promisify(req.login.bind(req));
  await login(user);
  req.flash('success', 'Profile successfully updated!');
  res.redirect(`back`);
}

